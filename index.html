<!DOCTYPE html>
<html lang="fi">
<head>
  <link rel="manifest" href="manifest.json">
  <script>
   if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
      // Rekisteröityminen onnistui, tarkistetaan päivitys
      if (reg) {
        reg.update(); // Pakottaa tarkistamaan päivitykset
      }
    }).catch(err => {
      console.error('Service workerin rekisteröinti epäonnistui:', err);
    });
  });
}
  </script>
<meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Department of Psychology</title>
  <style>
    body {
      font-family: 'Georgia', serif;
      margin: 1rem;
      background: #ffffff;
      color: #222;
      text-align: center;
    }
    h1 {
      font-size: 2.2rem;
      margin-bottom: 0.25rem;
    }
    h2 {
      font-size: 1.2rem;
      font-weight: normal;
      margin-top: 0;
      color: #555;
    }
    button {
      font-size: 1rem;
      padding: 0.6rem 1.2rem;
      margin: 0.3rem 0;
      width: 100%;
      max-width: 320px;
      display: block;
      border: 1px solid #444;
      border-radius: 6px;
      background-color: #f4f4f4;
      color: #222;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #e0e0e0;
    }
    .flash {
      animation: flash 2s infinite;
    }
    .alternate {
      animation: alternateFlash 2s infinite;
    }
    @keyframes flash {
      0%, 100% { background-color: #f4f4f4; }
      50% { background-color: #ffd700; }
    }
    @keyframes alternateFlash {
      0%, 100% { background-color: #f4f4f4; }
      50% { background-color: #add8e6; }
    }
    #tulos {
      margin-top: 2rem;
      font-size: 1.2rem;
    }
    .button-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.4rem;
    }
    .probability-text {
      font-size: 1rem;
      font-family: 'Courier New', monospace;
      color: #444;
    }
  </style>
</head>
<body>
  <h1>University of Birmingham</h1>
  <h2>CogniCard Study</h2>
  <div class="button-container">
    <button id="randomizeBtn" onclick="arvoJako()">Randomize</button>
    <button id="newCardBtn" onclick="arvoUusiKortti()">New Card</button>
    <button id="newPositionBtn" onclick="arvoUusiSumma()">New Position</button>
    <button onclick="confirmSelection()">Confirm Selection</button>
  </div>
  <div id="tulos"></div>
  <div id="todennakoisyys-container"></div>
  <div style="position: fixed; bottom: 0.5rem; left: 1rem; font-size: 0.8rem; color: #666; font-family: Georgia, serif;">
    v1.0.5
  </div>
  <script>
    let randomizeTimer, alternateTimer;
    const kortit = [...new Set(`6H,AS,8S,9S,KC,JD,5D,AH,3H,9H,3C,7S,7H,2S,QS,2H,QH,6D,2C,KD,4D,4H,JH,6C,4C,10C,4S,JS,2D,3S,9D,7D,AD,JC,8C,5S,AC,QC,QD,5H,7C,10H,9C,10D,8D,3D,8H,5C,6S,KH,10S,KS,4H,4D,KD,2C,6D,QH,2H,QS,2S,7H,7S,3C,9H,3H,AH,5D,JD,KC,9S,8S,AS,6H,6C,JH,10C,4C,KS,10S,KH,6S,5C,8H,3D,8D,10D,9C,10H,7C,5H,QD,QC,AC,5S,8C,JC,AD,7D,9D,3S,2D,JS,4S`.replace(/\s/g, '').split(',')
      .filter((v, i, a) => a.indexOf(v) === i))];
    let edellinenTulos = null;
    let viimeKortti = null;
    let viimeSumma = null;

    function getVisible(deck, n, m, method) {
      const visible = [];
      const pakka = method === 2 ? [...deck].reverse() : [...deck];
      let i = 0;
      for (let j = 0; j < n; j++) {
        visible.push(method === 0 ? pakka[i + 1] : pakka[i]);
        i += 2;
      }
      for (let j = 0; j < m; j++) {
        visible.push(pakka[i]);
        i++;
      }
      return visible;
    }

    function haeSallitutJaot(kortti) {
      const tulokset = [];
      const pakka = `6H,AS,8S,9S,KC,JD,5D,AH,3H,9H,3C,7S,7H,2S,QS,2H,QH,6D,2C,KD,4D,4H,JH,6C,4C,10C,4S,JS,2D,3S,9D,7D,AD,JC,8C,5S,AC,QC,QD,5H,7C,10H,9C,10D,8D,3D,8H,5C,6S,KH,10S,KS,4H,4D,KD,2C,6D,QH,2H,QS,2S,7H,7S,3C,9H,3H,AH,5D,JD,KC,9S,8S,AS,6H,6C,JH,10C,4C,KS,10S,KH,6S,5C,8H,3D,8D,10D,9C,10H,7C,5H,QD,QC,AC,5S,8C,JC,AD,7D,9D,3S,2D,JS,4S`.replace(/\s/g, '').split(',');
      for (let summa = 1; summa <= 52; summa++) {
        for (let method of [0, 2]) {
          for (let n = 0; n <= summa; n++) {
            const m = summa - n;
            if (2 * n + m > pakka.length || n + m >= 38 || m - n >= 30) continue;
            const näkyvät = getVisible(pakka, n, m, method);
            if (näkyvät[näkyvät.length - 1] === kortti && new Set(näkyvät).size === näkyvät.length) {
              tulokset.push({ kortti, n, m, metodi: method, summa: n + m });
              break;
            }
          }
        }
      }
      return tulokset;
    }

    function aloitaVilkutus() {
      document.getElementById("randomizeBtn").classList.add("flash");
    }

    function arvoJako() {
      selectionLocked = false;
      document.getElementById("todennakoisyys-container").innerHTML = '';
      lopetaVilkutus();
      while (true) {
        const kortti = kortit[Math.floor(Math.random() * kortit.length)];
        const jaot = haeSallitutJaot(kortti);
        if (jaot.length > 0) {
          const mahdolliset = jaot.filter(j => j.kortti !== viimeKortti || (j.n + j.m) !== viimeSumma);
          if (mahdolliset.length === 0) continue;
          const m0 = mahdolliset.filter(j => j.metodi === 0);
          const m2 = mahdolliset.filter(j => j.metodi !== 0);
          if (m0.length > 0 && Math.random() < 0.35) {
            edellinenTulos = m0[Math.floor(Math.random() * m0.length)];
          } else {
            edellinenTulos = mahdolliset[Math.floor(Math.random() * mahdolliset.length)];
          }
          viimeKortti = edellinenTulos.kortti;
          viimeSumma = edellinenTulos.n + edellinenTulos.m;
          naytaTulos();
          kaynnistaVaihtovuorottelu();
          break;
        }
      }
    }

    function arvoUusiKortti() {
      if (selectionLocked) {
        document.getElementById("randomizeBtn").classList.add("flash");
        return;
      }
      document.getElementById("todennakoisyys-container").innerHTML = '';
      if (!edellinenTulos) return;
      const nykyinenSumma = edellinenTulos.n + edellinenTulos.m;
      while (true) {
        const kortti = kortit[Math.floor(Math.random() * kortit.length)];
        const jaot = haeSallitutJaot(kortti).filter(j => j.n + j.m === nykyinenSumma);
        if (jaot.length > 0) {
          const mahdolliset = jaot.filter(j => j.kortti !== viimeKortti);
          if (mahdolliset.length === 0) continue;
          const m0 = mahdolliset.filter(j => j.metodi === 0);
        const m2 = mahdolliset.filter(j => j.metodi !== 0);
        if (m0.length > 0 && Math.random() < 0.6) {
          edellinenTulos = m0[Math.floor(Math.random() * m0.length)];
        } else {
          edellinenTulos = mahdolliset[Math.floor(Math.random() * mahdolliset.length)];
        }
        viimeKortti = edellinenTulos.kortti;
          viimeSumma = nykyinenSumma;
          naytaTulos();
          break;
        }
      }
    }

    function arvoUusiSumma() {
      if (selectionLocked) return;
      document.getElementById("todennakoisyys-container").innerHTML = '';
      if (!edellinenTulos) return;
      const kortti = edellinenTulos.kortti;
      const jaot = haeSallitutJaot(kortti).filter(j => j.n + j.m !== viimeSumma);
      if (jaot.length > 0) {
        const m0 = jaot.filter(j => j.metodi === 0);
      if (m0.length > 0 && Math.random() < 0.6) {
        edellinenTulos = m0[Math.floor(Math.random() * m0.length)];
      } else {
        edellinenTulos = jaot[Math.floor(Math.random() * jaot.length)];
      }
        viimeKortti = kortti;
        viimeSumma = edellinenTulos.n + edellinenTulos.m;
        naytaTulos();
      }
    }

    function naytaTulos() {
      const maaSymbolit = { 'S': '♠', 'H': '♥', 'D': '♦', 'C': '♣' };
      const kortti = edellinenTulos.kortti;
      const arvo = kortti.slice(0, -1);
      const maa = kortti.slice(-1);
      const symboli = maaSymbolit[maa] || maa;
      const color = (maa === 'H' || maa === 'D') ? 'red' : 'black';
      const korttiSymboli = `${arvo}<span style='color:${color}; font-size: 1.4em'>${symboli}</span>`;
      const el = document.getElementById("tulos");
      el.innerHTML = `Card: ${korttiSymboli}<br>Position: ${edellinenTulos.n + edellinenTulos.m}`;
    }

    function kaynnistaVaihtovuorottelu() {
      let state = false;
      alternateTimer = setInterval(() => {
        state = !state;
        document.getElementById("newCardBtn").classList.toggle("alternate", state);
        document.getElementById("newPositionBtn").classList.toggle("alternate", !state);
      }, 2000);
    }

    function lopetaVilkutus() {
      clearInterval(alternateTimer);
      document.getElementById("randomizeBtn").classList.remove("flash");
      document.getElementById("newCardBtn").classList.remove("alternate");
      document.getElementById("newPositionBtn").classList.remove("alternate");
    }

    let selectionLocked = false;

function confirmSelection() {
      if (!edellinenTulos) return;
      lopetaVilkutus();
      const { metodi, n, m } = edellinenTulos;
      const nStr = String(n).padStart(2, '0');
      const mStr = String(m).padStart(2, '0');
      const metodiStr = metodi === 0 ? "0" : (n === (n + m) ? "3" : "2");
      const todennakoisyys = `0.${metodiStr}${nStr}${mStr}%`;
      const container = document.getElementById("todennakoisyys-container");
      if (container) {
        const div = document.createElement("div");
        div.id = "todennakoisyys";
        div.className = "probability-text";
        div.innerHTML = `<br><br>Database updated.<br>Popularity of the selection: ${todennakoisyys}`;
        container.innerHTML = '';
        container.appendChild(div);
      selectionLocked = true;
        document.getElementById("randomizeBtn").classList.add("flash");
      }
    }
      document.addEventListener("DOMContentLoaded", () => {
      aloitaVilkutus();
    });
  </script>
  <div style="position: fixed; bottom: 0.5rem; left: 1rem; font-size: 0.8rem; color: #666; font-family: Georgia, serif;">
    v1.1.0
  </div>
</body>
</html>
